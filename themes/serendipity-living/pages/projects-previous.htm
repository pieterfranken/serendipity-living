url = "/projects/previous"
layout = "default"
title = "Previous Projects — Serendipity Living"
meta_title = "Previous Projects — Serendipity Living"
meta_description = "See our completed projects and their villas."
==
function onStart()
{
    $tiles = [];
    $projects = \Serendipity\Villas\Models\Project::previous()
        ->with(['villas.thumbnail', 'villas.gallery', 'hero'])
        ->orderBy('title')
        ->get();

    $pickImage = function($project){
        if (!$project) return '';
        $villa = $project->villas
            ->filter(function($v){ return $v->thumbnail || ($v->gallery && $v->gallery->count()); })
            ->shuffle()
            ->first();
        if ($villa) {
            if ($villa->thumbnail) return $villa->thumbnail->getPath();
            if ($villa->gallery && $villa->gallery->count()) {
                $first = $villa->gallery->first();
                if ($first) return $first->getPath();
            }
        }
        if ($project->hero) return $project->hero->getPath();
        return '';
    };

    foreach ($projects as $p) {
        $tiles[] = [
            'title' => $p->title,
            'slug'  => $p->slug,
            'image' => $pickImage($p)
        ];
    }

    $this['projectTiles'] = $tiles;
}
==
<section class="sl-container sl-section">
  <header class="sl-page-header sl-page-header--gold">
    <h1 class="sl-display">Previous Projects</h1>
  </header>
  {% if projectTiles|length %}
  <div class="sl-villas-grid">
    {% for t in projectTiles %}
      {% set url = t.image ?: ('assets/images/placeholder-villa.jpg'|theme) %}
      {% partial 'projects/card-villa-style' title=t.title href='/projects/' ~ t.slug image=url %}
    {% endfor %}
  </div>
  {% else %}
    <p>No previous projects available at this time.</p>
  {% endif %}
</section>
